<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - MG Cafe</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Editor Highlight */
        .editor-highlight { outline: 2px dashed #3b82f6 !important; cursor: pointer; }
        .editor-selected { outline: 3px solid #ef4444 !important; z-index: 10; position: relative; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #999; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-gray-800 font-sans">

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="material-icons text-red-600 text-3xl">admin_panel_settings</i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Admin Login</h2>
            <p class="text-gray-500 mb-6 text-sm">Enter access code to manage website.</p>
            <form id="loginForm" class="space-y-4">
                <input type="password" id="passwordInput" class="w-full border p-3 rounded focus:outline-none focus:border-red-500 transition" placeholder="Password" required>
                <button type="submit" class="w-full bg-red-600 text-white p-3 rounded font-bold hover:bg-red-700 transition">Access Dashboard</button>
            </form>
            <p id="loginError" class="text-red-500 text-sm mt-3 hidden">Access Denied: Incorrect Password</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="flex h-screen hidden">
        
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r flex-shrink-0 flex flex-col">
            <div class="h-16 flex items-center px-6 border-b font-bold text-red-600 text-xl tracking-wide">
                MG ADMIN
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="switchView('reservations')" class="nav-item w-full flex items-center px-4 py-3 text-gray-600 rounded-lg hover:bg-red-50 hover:text-red-600 transition active-nav" id="nav-res">
                    <i class="material-icons mr-3">event_seat</i> Reservations
                </button>
                <button onclick="switchView('editor')" class="nav-item w-full flex items-center px-4 py-3 text-gray-600 rounded-lg hover:bg-red-50 hover:text-red-600 transition" id="nav-edit">
                    <i class="material-icons mr-3">edit_note</i> Website Editor
                </button>
            </nav>
            <div class="p-4 border-t">
                <button onclick="logout()" class="w-full flex items-center px-4 py-2 text-red-500 hover:bg-red-50 rounded transition">
                    <i class="material-icons mr-3">logout</i> Logout
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            
            <!-- RESERVATIONS VIEW -->
            <div id="view-reservations" class="view-panel flex-1 overflow-auto p-8 bg-gray-50">
                <h1 class="text-2xl font-bold mb-6">Booking Requests</h1>
                
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-500">
                        <div class="text-gray-500 text-sm uppercase font-bold">Total Bookings</div>
                        <div class="text-3xl font-bold mt-2" id="totalCount">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
                        <div class="text-gray-500 text-sm uppercase font-bold">Today's Guests</div>
                        <div class="text-3xl font-bold mt-2" id="todayCount">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
                        <div class="text-gray-500 text-sm uppercase font-bold">Pending Actions</div>
                        <div class="text-3xl font-bold mt-2" id="pendingCount">0</div>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="text-left py-3 px-4 text-xs font-semibold text-gray-600 uppercase">Status</th>
                                <th class="text-left py-3 px-4 text-xs font-semibold text-gray-600 uppercase">Guest Details</th>
                                <th class="text-left py-3 px-4 text-xs font-semibold text-gray-600 uppercase">Date & Time</th>
                                <th class="text-left py-3 px-4 text-xs font-semibold text-gray-600 uppercase">Requests</th>
                                <th class="text-right py-3 px-4 text-xs font-semibold text-gray-600 uppercase">Action</th>
                            </tr>
                        </thead>
                        <tbody id="bookingTableBody" class="divide-y divide-gray-100">
                            <tr><td colspan="5" class="p-8 text-center text-gray-500">Loading bookings...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- EDITOR VIEW -->
            <div id="view-editor" class="view-panel hidden flex-1 flex flex-col h-full">
                <!-- Editor Toolbar -->
                <div class="h-14 bg-gray-800 text-white flex items-center justify-between px-4 shadow-md z-20">
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-medium bg-gray-700 px-3 py-1 rounded">Visual Mode</span>
                        <span class="text-xs text-gray-400">Click elements to edit</span>
                    </div>
                    <button onclick="saveWebsiteChanges()" class="save-btn flex items-center gap-2 bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-bold transition">
                        <i class="material-icons text-sm">save</i> Publish Live
                    </button>
                </div>

                <div class="flex-1 flex overflow-hidden relative">
                    <!-- The Canvas (Page Preview) -->
                    <div id="editor-canvas" class="flex-1 bg-white overflow-y-auto pb-20 shadow-inner">
                        <div class="p-20 text-center text-gray-400">Loading Editor...</div>
                    </div>

                    <!-- Properties Panel -->
                    <div id="properties-panel" class="w-80 bg-white border-l shadow-xl z-30 transform translate-x-full transition-transform duration-300 flex flex-col">
                        <div class="p-4 border-b bg-gray-50 font-bold flex justify-between items-center">
                            <span>Edit Element</span>
                            <button onclick="deselectElement()" class="text-gray-400 hover:text-red-500"><i class="material-icons">close</i></button>
                        </div>
                        <div class="p-4 flex-1 overflow-y-auto space-y-5">
                            <div class="text-xs font-bold text-gray-400 uppercase">Content</div>
                            
                            <!-- Text Edit -->
                            <div id="pg-text">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Text Content</label>
                                <textarea id="inp-text" class="w-full border rounded p-2 text-sm h-24" oninput="applyChange('text')"></textarea>
                            </div>
                            
                            <!-- Link Edit -->
                            <div id="pg-link" class="hidden">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Link URL</label>
                                <input type="text" id="inp-href" class="w-full border rounded p-2 text-sm" oninput="applyChange('href')">
                            </div>

                             <!-- Image Edit -->
                             <div id="pg-img" class="hidden">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Image URL</label>
                                <input type="text" id="inp-src" class="w-full border rounded p-2 text-sm" oninput="applyChange('src')">
                            </div>

                            <div class="border-t pt-4"></div>
                            <div class="text-xs font-bold text-gray-400 uppercase">Styling</div>

                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Text Color</label>
                                <div class="flex gap-2">
                                    <input type="color" id="inp-color" class="h-8 w-8 cursor-pointer border rounded" oninput="applyChange('style-color')">
                                    <input type="text" id="inp-color-text" class="flex-1 border rounded p-1 text-xs" readonly>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Background Color</label>
                                <div class="flex gap-2">
                                    <input type="color" id="inp-bg" class="h-8 w-8 cursor-pointer border rounded" oninput="applyChange('style-bg')">
                                    <input type="text" id="inp-bg-text" class="flex-1 border rounded p-1 text-xs" readonly>
                                </div>
                            </div>

                             <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Font Size</label>
                                <input type="text" id="inp-size" class="w-full border rounded p-2 text-sm" oninput="applyChange('style-size')">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Padding</label>
                                <input type="text" id="inp-padding" class="w-full border rounded p-2 text-sm" oninput="applyChange('style-padding')">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Default Template (Fallback if DB is empty) -->
    <template id="default-template">
        <section class="p-20 text-center bg-gray-50">
            <h1 class="text-4xl font-bold mb-4">Welcome to Your New Website</h1>
            <p class="mb-8">This is the default content. Click "Edit Website" to start customization.</p>
            <button class="bg-red-600 text-white px-6 py-2 rounded">Example Button</button>
        </section>
    </template>

    <!-- FIREBASE & ADMIN LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, setDoc, getDoc, serverTimestamp, signInAnonymously, getAuth } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth as getFirebaseAuth } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // CONFIG (Same fallback logic as index.html)
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
             firebaseConfig = {
                apiKey: "AIzaSyCdjr6GwvNtC-qqLhX7X0eOCZk54orEBto",
                authDomain: "fir-711c2.firebaseapp.com",
                projectId: "fir-711c2",
                storageBucket: "fir-711c2.firebasestorage.app",
                messagingSenderId: "212609923784",
                appId: "1:212609923784:web:43c274cea203256e2943fd",
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getFirebaseAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        const LOGIN_PASSWORD = "admin"; // Still client-side (Weak Security)

        // --- AUTH & INIT ---
        const loginForm = document.getElementById('loginForm');
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pwd = document.getElementById('passwordInput').value;
            
            if (pwd === LOGIN_PASSWORD) {
                try {
                    // REAL Auth for Database Access
                    await signInAnonymously(auth);
                    
                    document.getElementById('loginOverlay').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    initDashboard();
                } catch(err) {
                    alert("System Error: Could not connect to database. " + err.message);
                }
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        function logout() {
            location.reload();
        }

        function initDashboard() {
            loadReservations();
            loadEditor();
        }

        // --- NAVIGATION ---
        window.switchView = function(view) {
            document.getElementById('view-reservations').classList.add('hidden');
            document.getElementById('view-editor').classList.add('hidden');
            document.getElementById('nav-res').classList.remove('bg-red-50', 'text-red-600');
            document.getElementById('nav-edit').classList.remove('bg-red-50', 'text-red-600');

            if (view === 'reservations') {
                document.getElementById('view-reservations').classList.remove('hidden');
                document.getElementById('nav-res').classList.add('bg-red-50', 'text-red-600');
            } else {
                document.getElementById('view-editor').classList.remove('hidden');
                document.getElementById('nav-edit').classList.add('bg-red-50', 'text-red-600');
            }
        }

        // --- RESERVATIONS ---
        function loadReservations() {
            // Path Rule: artifacts/{appId}/public/data/bookings
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('bookingTableBody');
                tbody.innerHTML = '';
                
                let total = 0, today = 0, pending = 0;
                const todayStr = new Date().toISOString().split('T')[0];

                if(snapshot.empty) {
                    tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">No bookings yet.</td></tr>`;
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    total++;
                    if(data.date === todayStr) today++;
                    if(data.status === 'Pending') pending++;

                    const statusColors = {
                        'Pending': 'bg-orange-100 text-orange-700',
                        'Confirmed': 'bg-green-100 text-green-700'
                    };
                    const badgeClass = statusColors[data.status] || 'bg-gray-100 text-gray-700';

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition';
                    row.innerHTML = `
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${data.status}</span></td>
                        <td class="p-4">
                            <div class="font-bold text-gray-800">${data.name}</div>
                            <div class="text-sm text-gray-500">${data.phone}</div>
                        </td>
                        <td class="p-4 text-sm text-gray-600">${data.date}<br>${data.time}</td>
                        <td class="p-4 text-sm text-gray-600 max-w-xs truncate">${data.notes || '-'} (${data.guests} ppl, ${data.seating})</td>
                        <td class="p-4 text-right">
                            ${data.status === 'Pending' ? 
                                `<button onclick="confirmBooking('${id}')" class="text-green-600 hover:text-green-800 font-bold text-sm">Confirm</button>` : 
                                `<span class="text-green-600 material-icons text-sm">check_circle</span>`}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('totalCount').innerText = total;
                document.getElementById('todayCount').innerText = today;
                document.getElementById('pendingCount').innerText = pending;
            }, (error) => {
                console.error("Data Load Error:", error);
            });
        }

        window.confirmBooking = async (id) => {
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', id), { status: 'Confirmed' }, { merge: true });
            } catch(e) { alert("Error updating: " + e.message); }
        };

        // --- EDITOR LOGIC ---
        let selectedEl = null;

        async function loadEditor() {
            const canvas = document.getElementById('editor-canvas');
            
            try {
                // Fetch LIVE content
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'site_content', 'live_page');
                const docSnap = await getDoc(docRef);

                if(docSnap.exists() && docSnap.data().html) {
                    // Inject HTML into editor
                    canvas.innerHTML = docSnap.data().html;
                } else {
                    // Fallback to Template if no data
                    const tpl = document.getElementById('default-template').innerHTML;
                    canvas.innerHTML = tpl;
                }
            } catch(e) {
                canvas.innerHTML = `<div class="p-10 text-red-500">Error loading content: ${e.message}</div>`;
            }

            // Bind Editor Interactions
            canvas.addEventListener('mouseover', (e) => {
                e.stopPropagation();
                if(e.target !== selectedEl && e.target !== canvas) {
                    e.target.classList.add('editor-highlight');
                }
            });
            canvas.addEventListener('mouseout', (e) => {
                e.stopPropagation();
                e.target.classList.remove('editor-highlight');
            });
            canvas.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if(e.target !== canvas) selectElement(e.target);
            });
        }

        function selectElement(el) {
            // Cleanup previous
            if(selectedEl) selectedEl.classList.remove('editor-selected');
            
            selectedEl = el;
            selectedEl.classList.add('editor-selected');
            selectedEl.classList.remove('editor-highlight');
            
            // Show Panel
            document.getElementById('properties-panel').classList.remove('translate-x-full');
            
            // Populate Fields
            document.getElementById('inp-text').value = el.innerText;
            
            // Show/Hide Types
            const isImg = el.tagName === 'IMG';
            const isLink = el.tagName === 'A' || el.closest('a');
            
            document.getElementById('pg-img').classList.toggle('hidden', !isImg);
            document.getElementById('pg-text').classList.toggle('hidden', isImg); // Don't edit text of img
            document.getElementById('pg-link').classList.toggle('hidden', !isLink);

            if(isImg) document.getElementById('inp-src').value = el.src;
            if(isLink) document.getElementById('inp-href').value = el.getAttribute('href') || '#';
            
            // Styles
            const s = window.getComputedStyle(el);
            const rgbToHex = (rgb) => {
                const res = rgb.match(/\d+/g);
                return res ? "#" + res.map(x => (+x).toString(16).padStart(2,'0')).join('') : '#000000';
            };
            
            document.getElementById('inp-color').value = rgbToHex(s.color);
            document.getElementById('inp-bg').value = rgbToHex(s.backgroundColor);
            document.getElementById('inp-size').value = s.fontSize;
            document.getElementById('inp-padding').value = s.padding;
        }

        window.deselectElement = function() {
            if(selectedEl) selectedEl.classList.remove('editor-selected');
            selectedEl = null;
            document.getElementById('properties-panel').classList.add('translate-x-full');
        }

        window.applyChange = function(type) {
            if(!selectedEl) return;
            
            const val = (id) => document.getElementById(id).value;
            
            if(type === 'text') selectedEl.innerText = val('inp-text');
            if(type === 'href') selectedEl.setAttribute('href', val('inp-href'));
            if(type === 'src') selectedEl.src = val('inp-src');
            
            if(type === 'style-color') selectedEl.style.color = val('inp-color');
            if(type === 'style-bg') selectedEl.style.backgroundColor = val('inp-bg');
            if(type === 'style-size') selectedEl.style.fontSize = val('inp-size');
            if(type === 'style-padding') selectedEl.style.padding = val('inp-padding');
        }

        window.saveWebsiteChanges = async function() {
            const btn = document.querySelector('.save-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'Saving...';
            
            // Remove editor classes before saving
            if(selectedEl) selectedEl.classList.remove('editor-selected');
            document.querySelectorAll('.editor-highlight').forEach(el => el.classList.remove('editor-highlight'));
            
            const cleanHTML = document.getElementById('editor-canvas').innerHTML;
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'site_content', 'live_page'), {
                    html: cleanHTML,
                    updatedAt: serverTimestamp()
                });
                alert("Published Successfully! The live site is updated.");
            } catch(e) {
                alert("Error saving: " + e.message);
            }
            btn.innerHTML = originalHTML;
        }
    </script>
</body>
</html>
