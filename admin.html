<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - MG Cafe & Restro</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* --- ORIGINAL CSS RESTORED --- */
        :root { --primary: #d32f2f; --dark: #333; --bg: #f4f6f8; --success: #388e3c; --panel-width: 300px; }
        body { margin: 0; font-family: 'Open Sans', sans-serif; background: var(--bg); color: var(--dark); height: 100vh; overflow: hidden; }
        
        /* Login Overlay */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .login-box { text-align: center; max-width: 300px; width: 100%; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; }
        
        /* Dashboard Layout */
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 220px; background: #fff; border-right: 1px solid #eee; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        .nav-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #555; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #ffebee; color: var(--primary); border-right: 3px solid var(--primary); }
        .logout { margin-top: auto; border-top: 1px solid #eee; color: #d32f2f; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        
        /* Views */
        .view { display: none; height: 100%; }
        .view.active { display: block; }

        /* --- Reservations View Styles --- */
        #view-reservations { padding: 20px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); }
        .stat-num { font-size: 2rem; font-weight: bold; }
        .stat-label { color: #666; font-size: 0.9rem; }

        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: #555; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .badge-Pending { background: #fff3e0; color: #ef6c00; }
        .badge-Confirmed { background: #e8f5e9; color: #2e7d32; }
        
        /* --- Simple Editor Styles --- */
        #view-editor { position: relative; background: #ddd; }
        
        /* The Toolbar */
        .editor-top-bar {
            height: 50px; background: #333; color: white; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .save-btn { background: var(--success); border: none; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .save-btn:hover { background: #2e7d32; }

        /* The Canvas */
        #editor-canvas { 
            height: calc(100% - 50px); width: 100%; overflow-y: auto; background: white; padding-bottom: 50px;
            padding-right: var(--panel-width); 
        }

        /* The Properties Panel */
        #properties-panel {
            position: absolute; top: 50px; right: 0; width: var(--panel-width); height: calc(100% - 50px);
            background: #fff; border-left: 1px solid #ccc; box-shadow: -2px 0 10px rgba(0,0,0,0.05);
            display: none; flex-direction: column; overflow-y: auto;
        }
        #properties-panel.active { display: flex; }
        
        .panel-header { padding: 15px; background: #f9f9f9; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; }
        .panel-content { padding: 15px; }
        
        .prop-group { margin-bottom: 15px; }
        .prop-label { font-size: 12px; color: #666; display: block; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; }
        .prop-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }
        .prop-textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px; resize: vertical; }
        
        /* Highlight Overlay */
        .highlight-box {
            position: absolute; border: 2px solid #2196f3; pointer-events: none; z-index: 999; display: none;
        }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: var(--primary);">MG Cafe Admin</h2>
            <p>Please log in to manage your website.</p>
            <form id="loginForm">
                <input type="password" id="passwordInput" class="login-input" placeholder="Password" required>
                <button type="submit" class="login-btn">Login</button>
            </form>
            <p id="loginError" style="color: red; margin-top: 10px; display: none;">Incorrect password</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <div class="app-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <i class="material-icons">restaurant_menu</i> MG Admin
                </div>
                <div class="nav-item active" onclick="switchView('reservations')">
                    <i class="material-icons">event_seat</i> Reservations
                </div>
                <div class="nav-item" onclick="switchView('editor')">
                    <i class="material-icons">touch_app</i> Click Editor
                </div>
                <div class="nav-item logout" onclick="logout()">
                    <i class="material-icons">logout</i> Logout
                </div>
            </div>

            <div class="main-content">
                
                <!-- RESERVATIONS VIEW -->
                <div id="view-reservations" class="view active">
                    <h2 style="margin-top: 0;">Table Bookings</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-num" id="totalCount">0</div>
                            <div class="stat-label">Total Reservations</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #388e3c;">
                            <div class="stat-num" id="todayCount">0</div>
                            <div class="stat-label">For Today</div>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Guest</th>
                                    <th>Details</th>
                                    <th>Requests</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody">
                                <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- EDITOR VIEW -->
                <div id="view-editor" class="view">
                    <div class="editor-top-bar">
                        <span style="font-size: 14px;">Mode: <b>Click an element to edit</b></span>
                        <button class="save-btn" onclick="saveWebsiteChanges()">
                            <i class="material-icons" style="font-size: 18px;">cloud_upload</i> Publish Changes
                        </button>
                    </div>

                    <!-- Editor Canvas (Where we load the page) -->
                    <div id="editor-canvas">
                        <div style="padding: 50px; text-align: center;">Loading Page...</div>
                    </div>

                    <!-- Right Property Panel -->
                    <div id="properties-panel">
                        <div class="panel-header">
                            <span>Edit Element</span>
                            <span id="el-tag" style="color: #999; font-weight: normal; font-size: 12px;">DIV</span>
                        </div>
                        <div class="panel-content">
                            <!-- TEXT -->
                            <div class="prop-group" id="pg-text">
                                <label class="prop-label">Text Content</label>
                                <textarea id="inp-text" class="prop-textarea" oninput="applyChange('text')"></textarea>
                            </div>
                            <!-- LINK -->
                            <div class="prop-group" id="pg-link" style="display:none;">
                                <label class="prop-label">Link URL (href)</label>
                                <input type="text" id="inp-href" class="prop-input" oninput="applyChange('href')">
                            </div>
                            <!-- IMAGE -->
                            <div class="prop-group" id="pg-img" style="display:none;">
                                <label class="prop-label">Image Source URL</label>
                                <input type="text" id="inp-src" class="prop-input" oninput="applyChange('src')">
                            </div>
                            
                            <!-- BACKGROUND IMAGE (New) -->
                            <div class="prop-group" id="pg-bg-img">
                                <label class="prop-label">Background Image URL</label>
                                <input type="text" id="inp-bg-img" class="prop-input" oninput="applyChange('style-bg-img')">
                            </div>
                            
                            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                            
                            <!-- STYLES -->
                            <div class="prop-group">
                                <label class="prop-label">Text Color</label>
                                <input type="color" id="inp-color" class="prop-input" style="height: 40px; cursor: pointer;" oninput="applyChange('style-color')">
                            </div>
                            <div class="prop-group">
                                <label class="prop-label">Background Color</label>
                                <input type="color" id="inp-bg" class="prop-input" style="height: 40px; cursor: pointer;" oninput="applyChange('style-bg')">
                            </div>
                            <div class="prop-group">
                                <label class="prop-label">Font Size (px, rem)</label>
                                <input type="text" id="inp-size" class="prop-input" oninput="applyChange('style-size')">
                            </div>
                            <div class="prop-group">
                                <label class="prop-label">Border Radius (px)</label>
                                <input type="text" id="inp-radius" class="prop-input" oninput="applyChange('style-radius')">
                            </div>
                            <div class="prop-group">
                                <label class="prop-label">Padding</label>
                                <input type="text" id="inp-padding" class="prop-input" oninput="applyChange('style-padding')">
                            </div>
                            <div class="prop-group">
                                <label class="prop-label">Margin</label>
                                <input type="text" id="inp-margin" class="prop-input" oninput="applyChange('style-margin')">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- CONFIG ---
        const LOGIN_PASSWORD = "admin"; 
        
        // Use environment config if available (Fix for "System Fucked" issue: connect to correct project)
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
             firebaseConfig = {
                apiKey: "AIzaSyCdjr6GwvNtC-qqLhX7X0eOCZk54orEBto",
                authDomain: "fir-711c2.firebaseapp.com",
                projectId: "fir-711c2",
                storageBucket: "fir-711c2.firebasestorage.app",
                messagingSenderId: "212609923784",
                appId: "1:212609923784:web:43c274cea203256e2943fd",
            };
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        // --- AUTHENTICATION ---
        const loginForm = document.getElementById('loginForm');
        
        // Note: We authenticate with Firebase silently only after the user enters the correct password
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pwd = document.getElementById('passwordInput').value;
            
            if(pwd === LOGIN_PASSWORD) {
                const btn = e.target.querySelector('button');
                const originalText = btn.innerText;
                btn.innerText = "Connecting...";
                
                try {
                    // CRITICAL FIX: Authenticate before accessing DB
                    await signInAnonymously(auth);
                    
                    showDashboard();
                } catch(error) {
                    alert("Database Connection Error: " + error.message);
                }
                btn.innerText = originalText;
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        window.logout = function() {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            initReservations();
        }

        window.switchView = function(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const navItems = document.querySelectorAll('.nav-item');
            if(viewName === 'reservations') navItems[0].classList.add('active');
            if(viewName === 'editor') navItems[1].classList.add('active');

            document.getElementById('view-' + viewName).classList.add('active');

            if(viewName === 'editor') initEditor();
        }

        // --- RESERVATIONS LOGIC ---
        function initReservations() {
            // CRITICAL FIX: Use 'artifacts' path for this environment
            const q = query(collection(db, "artifacts", appId, "public", "data", "bookings"), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('bookingTableBody');
                tbody.innerHTML = '';
                let total = 0, today = 0;
                const todayStr = new Date().toISOString().split('T')[0];

                if(snapshot.empty) {
                     tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No bookings found.</td></tr>';
                     return;
                }

                snapshot.forEach((docSnapshot) => {
                    total++;
                    const data = docSnapshot.data();
                    if(data.date === todayStr) today++;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="badge badge-${data.status}">${data.status}</span></td>
                        <td><strong>${data.name}</strong><br><small>${data.phone}</small></td>
                        <td>${data.date}<br>${data.time}</td>
                        <td><small>${data.notes || '-'}</small></td>
                        <td>${data.status === 'Pending' ? `<button onclick="confirmBk('${docSnapshot.id}')" style="color:green;cursor:pointer;">Confirm</button>` : 'âœ“'}</td>
                    `;
                    tbody.appendChild(row);
                });
                document.getElementById('totalCount').innerText = total;
                document.getElementById('todayCount').innerText = today;
            });
        }
        
        window.confirmBk = async (id) => {
             // CRITICAL FIX: Use 'artifacts' path
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "bookings", id), { status: "Confirmed" });
        }

        // --- SIMPLE EDITOR LOGIC ---
        let selectedEl = null;

        async function initEditor() {
            const canvas = document.getElementById('editor-canvas');
            
            // 1. Load HTML
            let htmlContent = '';
            try {
                // CRITICAL FIX: Use 'artifacts' path
                const docSnap = await getDoc(doc(db, "artifacts", appId, "public", "data", "site_content", "live_page"));
                if(docSnap.exists() && docSnap.data().html) {
                    htmlContent = docSnap.data().html;
                } else {
                    // Fallback to a default template if local fetch fails in this environment
                    htmlContent = `
                        <div style="padding:40px; text-align:center;">
                            <h1>Welcome to MG Cafe</h1>
                            <p>This is default content. Go to the live page to see the full site.</p>
                        </div>
                    `;
                }
            } catch(e) { htmlContent = "<div>Load Error</div>"; }

            canvas.innerHTML = htmlContent;

            // 2. Add Interactions
            canvas.addEventListener('mouseover', (e) => {
                e.stopPropagation();
                if(e.target !== canvas) e.target.style.outline = "1px dashed #2196f3";
            });
            
            canvas.addEventListener('mouseout', (e) => {
                e.stopPropagation();
                if(e.target !== selectedEl) e.target.style.outline = "none";
            });

            canvas.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if(e.target !== canvas) selectElement(e.target);
            });
        }

        function selectElement(el) {
            if(selectedEl) selectedEl.style.outline = "none";
            selectedEl = el;
            selectedEl.style.outline = "2px solid #d32f2f";
            
            const panel = document.getElementById('properties-panel');
            panel.classList.add('active');
            
            document.getElementById('el-tag').innerText = el.tagName;
            document.getElementById('inp-text').value = el.innerText;
            
            const linkGroup = document.getElementById('pg-link');
            if(el.tagName === 'A' || el.closest('a')) {
                linkGroup.style.display = 'block';
                document.getElementById('inp-href').value = el.getAttribute('href') || '#';
            } else {
                linkGroup.style.display = 'none';
            }
            
            const imgGroup = document.getElementById('pg-img');
            if(el.tagName === 'IMG') {
                imgGroup.style.display = 'block';
                document.getElementById('inp-src').value = el.src;
                document.getElementById('pg-text').style.display = 'none';
            } else {
                imgGroup.style.display = 'none';
                document.getElementById('pg-text').style.display = 'block';
            }
            
            const style = window.getComputedStyle(el);
            const rgbToHex = (rgb) => {
                if(!rgb || rgb === 'rgba(0, 0, 0, 0)') return '#ffffff';
                const rgbMatch = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
                if(!rgbMatch) return '#000000';
                return "#" + ("0" + parseInt(rgbMatch[1],10).toString(16)).slice(-2) +
                             ("0" + parseInt(rgbMatch[2],10).toString(16)).slice(-2) +
                             ("0" + parseInt(rgbMatch[3],10).toString(16)).slice(-2);
            };

            document.getElementById('inp-color').value = rgbToHex(style.color);
            document.getElementById('inp-bg').value = rgbToHex(style.backgroundColor);
            document.getElementById('inp-size').value = style.fontSize;
            document.getElementById('inp-padding').value = style.padding;
            document.getElementById('inp-margin').value = style.margin;
            document.getElementById('inp-radius').value = style.borderRadius;
            
            let bgImg = style.backgroundImage;
            if(bgImg && bgImg !== 'none') {
                bgImg = bgImg.replace(/^url\(['"]?/, '').replace(/['"]?\)$/, '');
                document.getElementById('inp-bg-img').value = bgImg;
            } else {
                document.getElementById('inp-bg-img').value = '';
            }
        }

        window.applyChange = function(type) {
            if(!selectedEl) return;
            
            if(type === 'text') selectedEl.innerText = document.getElementById('inp-text').value;
            if(type === 'href') selectedEl.setAttribute('href', document.getElementById('inp-href').value);
            if(type === 'src') selectedEl.src = document.getElementById('inp-src').value;
            
            if(type === 'style-color') selectedEl.style.color = document.getElementById('inp-color').value;
            if(type === 'style-bg') selectedEl.style.backgroundColor = document.getElementById('inp-bg').value;
            if(type === 'style-size') selectedEl.style.fontSize = document.getElementById('inp-size').value;
            if(type === 'style-padding') selectedEl.style.padding = document.getElementById('inp-padding').value;
            if(type === 'style-margin') selectedEl.style.margin = document.getElementById('inp-margin').value;
            if(type === 'style-radius') selectedEl.style.borderRadius = document.getElementById('inp-radius').value;
            
            if(type === 'style-bg-img') {
                const url = document.getElementById('inp-bg-img').value;
                selectedEl.style.backgroundImage = url ? `url('${url}')` : 'none';
            }
        }

        window.saveWebsiteChanges = async function() {
            const btn = document.querySelector('.save-btn');
            btn.innerHTML = 'Saving...';
            
            if(selectedEl) selectedEl.style.outline = "none";
            
            const html = document.getElementById('editor-canvas').innerHTML;
            
            try {
                 // CRITICAL FIX: Use 'artifacts' path
                await setDoc(doc(db, "artifacts", appId, "public", "data", "site_content", "live_page"), {
                    html: html,
                    updatedAt: serverTimestamp()
                });
                alert("Published Successfully!");
            } catch(e) {
                alert("Error: " + e.message);
            }
            btn.innerHTML = '<i class="material-icons">cloud_upload</i> Publish Changes';
        }

    </script>
</body>
</html>
