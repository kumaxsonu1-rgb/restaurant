<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - MG Cafe & Restro</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    
    <style>
        :root { --primary: #d32f2f; --dark: #333; --bg: #f4f6f8; --success: #388e3c; }
        body { margin: 0; font-family: 'Open Sans', sans-serif; background: var(--bg); color: var(--dark); height: 100vh; overflow: hidden; }
        
        /* Login Overlay */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .login-box { text-align: center; max-width: 300px; width: 100%; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; }
        
        /* Dashboard Layout */
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: #fff; border-right: 1px solid #eee; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        .nav-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #555; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #ffebee; color: var(--primary); border-right: 3px solid var(--primary); }
        .logout { margin-top: auto; border-top: 1px solid #eee; color: #d32f2f; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        
        /* Views */
        .view { display: none; }
        .view.active { display: block; }

        /* --- Reservations View Styles --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); }
        .stat-num { font-size: 2rem; font-weight: bold; }
        .stat-label { color: #666; font-size: 0.9rem; }

        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: #555; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .badge-Pending { background: #fff3e0; color: #ef6c00; }
        .badge-Confirmed { background: #e8f5e9; color: #2e7d32; }
        
        /* --- Editor View Styles --- */
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .save-btn { background: var(--success); color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .save-btn:hover { background: #2e7d32; }

        /* The Live Preview Container */
        #editor-canvas { 
            background: #fff; 
            min-height: 600px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            border-radius: 4px; 
            position: relative;
        }
        
        /* Visual cues for editing */
        .editable-section { position: relative; border: 2px solid transparent; transition: 0.2s; cursor: move; }
        .editable-section:hover { border: 2px dashed #2196f3; }
        .editable-section::after {
            content: 'Drag to Move'; position: absolute; top: 0; right: 0; background: #2196f3; color: white; font-size: 10px; padding: 2px 5px; display: none;
        }
        .editable-section:hover::after { display: block; }
        
        [contenteditable="true"]:hover { outline: 2px solid var(--primary); }
        [contenteditable="true"]:focus { outline: 2px solid var(--primary); background: #fffde7; }
        
        .img-edit-overlay {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 5px; font-size: 12px; cursor: pointer; border-radius: 4px; display: none; z-index: 10;
        }
        .col:hover .img-edit-overlay { display: block; }

    </style>
</head>
<body>

    <!-- Login -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: var(--primary);">MG Cafe Admin</h2>
            <p>Please log in to manage your website.</p>
            <form id="loginForm">
                <input type="password" id="passwordInput" class="login-input" placeholder="Password" required>
                <button type="submit" class="login-btn">Login</button>
            </form>
            <p id="loginError" style="color: red; margin-top: 10px; display: none;">Incorrect password</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <div class="app-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <i class="material-icons">restaurant_menu</i> MG Admin
                </div>
                <div class="nav-item active" onclick="switchView('reservations')">
                    <i class="material-icons">event_seat</i> Reservations
                </div>
                <div class="nav-item" onclick="switchView('editor')">
                    <i class="material-icons">edit</i> Website Editor
                </div>
                <div class="nav-item logout" onclick="logout()">
                    <i class="material-icons">logout</i> Logout
                </div>
            </div>

            <div class="main-content">
                <!-- RESERVATIONS VIEW -->
                <div id="view-reservations" class="view active">
                    <h2 style="margin-top: 0;">Table Bookings</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-num" id="totalCount">0</div>
                            <div class="stat-label">Total Reservations</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #388e3c;">
                            <div class="stat-num" id="todayCount">0</div>
                            <div class="stat-label">For Today</div>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Guest</th>
                                    <th>Details</th>
                                    <th>Seating</th>
                                    <th>Requests</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody">
                                <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- EDITOR VIEW -->
                <div id="view-editor" class="view">
                    <div class="editor-header">
                        <div>
                            <h2 style="margin: 0;">Live Website Editor</h2>
                            <span style="font-size: 0.9rem; color: #666;">Drag sections to reorder. Click text to edit.</span>
                        </div>
                        <button class="save-btn" onclick="saveWebsiteChanges()">
                            <i class="material-icons">save</i> Publish Changes
                        </button>
                    </div>

                    <!-- This container will hold the fetched index.html content -->
                    <div id="editor-canvas">
                        <div style="padding: 50px; text-align: center; color: #999;">
                            Loading Landing Page...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIG ---
        const LOGIN_PASSWORD = "admin"; // Change this before deploying
        
        // TODO: PASTE YOUR FIREBASE CONFIG HERE
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abc123456"
        };
        // --- END CONFIG ---

        // Init App
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- AUTHENTICATION ---
        const loginForm = document.getElementById('loginForm');
        if(sessionStorage.getItem('isLoggedIn') === 'true') showDashboard();

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(document.getElementById('passwordInput').value === LOGIN_PASSWORD) {
                sessionStorage.setItem('isLoggedIn', 'true');
                showDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        window.logout = function() {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            initReservations();
            initEditor();
        }

        // --- NAVIGATION ---
        window.switchView = function(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('view-' + viewName).classList.add('active');
            // Basic active state toggling for nav items would go here (simplified)
        }

        // --- RESERVATIONS LOGIC ---
        function initReservations() {
            const q = query(collection(db, "bookings"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('bookingTableBody');
                tbody.innerHTML = '';
                
                let total = 0;
                let today = 0;
                const todayStr = new Date().toISOString().split('T')[0];

                snapshot.forEach((docSnapshot) => {
                    total++;
                    const data = docSnapshot.data();
                    if(data.date === todayStr) today++;
                    const id = docSnapshot.id;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="badge badge-${data.status}">${data.status}</span></td>
                        <td>
                            <div style="font-weight: bold;">${data.name}</div>
                            <a href="tel:${data.phone}" style="color: #666; font-size: 0.9rem;">${data.phone}</a>
                        </td>
                        <td>
                            <div style="font-weight: bold;">${data.date}</div>
                            <div style="font-size: 0.85rem;">${data.time}</div>
                        </td>
                        <td>
                            <div>${data.guests} Ppl</div>
                            <div style="font-size: 0.8rem; color: #888;">${data.seating}</div>
                        </td>
                         <td style="font-size: 0.9rem; max-width: 200px;">
                            ${data.occasion !== 'Casual' ? `<span style="color: purple; font-size: 0.8rem;">â˜… ${data.occasion}</span><br>` : ''}
                            ${data.notes || '-'}
                        </td>
                        <td>
                            ${data.status === 'Pending' ? 
                                `<button onclick="updateStatus('${id}', 'Confirmed')" style="color: green; cursor: pointer; border: 1px solid green; background: none; border-radius: 4px;">Confirm</button>` : 
                                '<i class="material-icons" style="color: green; font-size: 18px;">check_circle</i>'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('totalCount').innerText = total;
                document.getElementById('todayCount').innerText = today;
            });
        }

        window.updateStatus = async function(id, status) {
            await updateDoc(doc(db, "bookings", id), { status: status });
        }

        // --- EDITOR LOGIC ---
        async function initEditor() {
            const canvas = document.getElementById('editor-canvas');
            
            // 1. Try to fetch existing live content from Firebase first
            let htmlContent = '';
            try {
                const docSnap = await getDoc(doc(db, "site_content", "live_page"));
                if(docSnap.exists() && docSnap.data().html) {
                    htmlContent = docSnap.data().html;
                }
            } catch(e) { console.error(e); }

            // 2. If no Firebase content, fetch the static index.html from server to use as base
            if (!htmlContent) {
                try {
                    const response = await fetch('index.html');
                    const text = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    htmlContent = doc.getElementById('main-content').innerHTML;
                } catch (e) {
                    htmlContent = "<div>Error loading content. Please check console.</div>";
                }
            }

            // 3. Render content
            canvas.innerHTML = htmlContent;

            // 4. Make it editable
            prepareEditor(canvas);
        }

        function prepareEditor(canvas) {
            // A. Make text editable
            const textElements = canvas.querySelectorAll('h1, h2, h3, p, span, .price, .btn');
            textElements.forEach(el => {
                el.contentEditable = "true";
            });

            // B. Initialize Drag and Drop (SortableJS)
            // We apply it to the main container so sections can be reordered
            new Sortable(canvas, {
                animation: 150,
                handle: '.gjs-ft-section', // Drag handle
                draggable: '.gjs-ft-section', // Draggable items
                ghostClass: 'sortable-ghost',
            });

            // C. Make sections clearly selectable
            const sections = canvas.querySelectorAll('.gjs-ft-section');
            sections.forEach(sec => {
                sec.classList.add('editable-section');
            });
            
            // D. Image Editing (Simple Prompt)
            const images = canvas.querySelectorAll('img');
            images.forEach(img => {
                img.style.cursor = "pointer";
                img.title = "Click to change image URL";
                img.onclick = (e) => {
                    e.preventDefault(); // prevent link clicks if inside 'a' tag
                    const newUrl = prompt("Enter new image URL:", img.src);
                    if(newUrl) img.src = newUrl;
                }
            });
            
             // Disable links in editor so we can edit button text without navigating
             const links = canvas.querySelectorAll('a');
             links.forEach(a => {
                 a.onclick = (e) => e.preventDefault();
             });
        }

        window.saveWebsiteChanges = async function() {
            const btn = document.querySelector('.save-btn');
            btn.innerHTML = 'Saving...';
            
            const canvas = document.getElementById('editor-canvas');
            
            // Cleanup before saving (remove editor specific classes/attributes)
            // We clone the node so we don't break the active editor
            const clone = canvas.cloneNode(true);
            
            clone.querySelectorAll('[contenteditable]').forEach(el => el.removeAttribute('contenteditable'));
            clone.querySelectorAll('.editable-section').forEach(el => el.classList.remove('editable-section'));
            
            const cleanHtml = clone.innerHTML;

            try {
                await setDoc(doc(db, "site_content", "live_page"), {
                    html: cleanHtml,
                    updatedAt: serverTimestamp()
                });
                alert("Changes Published Live!");
            } catch(e) {
                alert("Error saving: " + e.message);
            }
            
            btn.innerHTML = '<i class="material-icons">save</i> Publish Changes';
        }

    </script>
</body>
</html>
