<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - MG Cafe & Restro</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- GrapesJS (The "Super Advanced" Editor Core) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.21.2/css/grapes.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/grapesjs/0.21.2/grapes.min.js"></script>
    <!-- GrapesJS Preset (Adds the default blocks and styles) -->
    <script src="https://unpkg.com/grapesjs-preset-webpage@1.0.2"></script>

    <style>
        :root { --primary: #d32f2f; --dark: #333; --bg: #f4f6f8; --success: #388e3c; }
        body { margin: 0; font-family: 'Open Sans', sans-serif; background: var(--bg); color: var(--dark); height: 100vh; overflow: hidden; }
        
        /* Login Overlay */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .login-box { text-align: center; max-width: 300px; width: 100%; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; }
        
        /* Dashboard Layout */
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: #fff; border-right: 1px solid #eee; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        .nav-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #555; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #ffebee; color: var(--primary); border-right: 3px solid var(--primary); }
        .logout { margin-top: auto; border-top: 1px solid #eee; color: #d32f2f; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        
        /* Views */
        .view { display: none; height: 100%; }
        .view.active { display: block; }

        /* --- Reservations View Styles --- */
        #view-reservations { padding: 20px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); }
        .stat-num { font-size: 2rem; font-weight: bold; }
        .stat-label { color: #666; font-size: 0.9rem; }

        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: #555; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .badge-Pending { background: #fff3e0; color: #ef6c00; }
        .badge-Confirmed { background: #e8f5e9; color: #2e7d32; }
        
        /* --- Advanced Editor View Styles --- */
        #view-editor { height: 100%; display: none; }
        #view-editor.active { display: flex; flex-direction: column; }
        
        /* Custom Toolbar for Save Action */
        .editor-toolbar {
            background: #2e2e2e;
            color: #fff;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }
        .save-btn { 
            background: var(--success); color: #fff; border: none; 
            padding: 8px 20px; border-radius: 4px; cursor: pointer; 
            font-weight: bold; display: flex; align-items: center; gap: 8px; 
            transition: 0.2s;
        }
        .save-btn:hover { background: #2e7d32; transform: translateY(-1px); }

        /* GrapesJS Overrides to fit layout */
        .gjs-cv-canvas { width: 100%; height: 100%; top: 0; }
        .gjs-pn-panels { border-bottom: none; }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: var(--primary);">MG Cafe Admin</h2>
            <p>Please log in to manage your website.</p>
            <form id="loginForm">
                <input type="password" id="passwordInput" class="login-input" placeholder="Password" required>
                <button type="submit" class="login-btn">Login</button>
            </form>
            <p id="loginError" style="color: red; margin-top: 10px; display: none;">Incorrect password</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <div class="app-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <i class="material-icons">restaurant_menu</i> MG Admin
                </div>
                <div class="nav-item active" onclick="switchView('reservations')">
                    <i class="material-icons">event_seat</i> Reservations
                </div>
                <div class="nav-item" onclick="switchView('editor')">
                    <i class="material-icons">edit</i> Advanced Editor
                </div>
                <div class="nav-item logout" onclick="logout()">
                    <i class="material-icons">logout</i> Logout
                </div>
            </div>

            <div class="main-content">
                <!-- RESERVATIONS VIEW -->
                <div id="view-reservations" class="view active">
                    <h2 style="margin-top: 0;">Table Bookings</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-num" id="totalCount">0</div>
                            <div class="stat-label">Total Reservations</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #388e3c;">
                            <div class="stat-num" id="todayCount">0</div>
                            <div class="stat-label">For Today</div>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Guest</th>
                                    <th>Details</th>
                                    <th>Seating</th>
                                    <th>Requests</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody">
                                <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- EDITOR VIEW -->
                <div id="view-editor" class="view">
                    <div class="editor-toolbar">
                        <span><i class="material-icons" style="vertical-align: middle; font-size: 18px;">construction</i> Site Builder Mode</span>
                        <button class="save-btn" onclick="saveWebsiteChanges()">
                            <i class="material-icons" style="font-size: 18px;">cloud_upload</i> Publish Live
                        </button>
                    </div>
                    <!-- GrapesJS Editor Container -->
                    <div id="gjs" style="height:100%; overflow: hidden;">
                        <div style="text-align: center; padding-top: 50px; color: #fff;">Initializing Editor...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIG ---
        const LOGIN_PASSWORD = "admin"; // Change this before deploying
        
        // TODO: PASTE YOUR FIREBASE CONFIG HERE
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abc123456"
        };
        // --- END CONFIG ---

        // Init App
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL EDITOR REFERENCE ---
        window.editor = null;

        // --- AUTHENTICATION ---
        const loginForm = document.getElementById('loginForm');
        if(sessionStorage.getItem('isLoggedIn') === 'true') showDashboard();

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(document.getElementById('passwordInput').value === LOGIN_PASSWORD) {
                sessionStorage.setItem('isLoggedIn', 'true');
                showDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        window.logout = function() {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            initReservations();
            // We delay editor init until tab switch to ensure DOM is ready and container has size
        }

        // --- NAVIGATION ---
        window.switchView = function(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Highlight nav item (simple hack for this 2-item menu)
            const navItems = document.querySelectorAll('.nav-item');
            if(viewName === 'reservations') navItems[0].classList.add('active');
            if(viewName === 'editor') navItems[1].classList.add('active');

            const targetView = document.getElementById('view-' + viewName);
            targetView.classList.add('active');

            if(viewName === 'editor' && !window.editor) {
                initGrapesEditor();
            }
        }

        // --- RESERVATIONS LOGIC ---
        function initReservations() {
            const q = query(collection(db, "bookings"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('bookingTableBody');
                tbody.innerHTML = '';
                
                let total = 0;
                let today = 0;
                const todayStr = new Date().toISOString().split('T')[0];

                snapshot.forEach((docSnapshot) => {
                    total++;
                    const data = docSnapshot.data();
                    if(data.date === todayStr) today++;
                    const id = docSnapshot.id;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="badge badge-${data.status}">${data.status}</span></td>
                        <td>
                            <div style="font-weight: bold;">${data.name}</div>
                            <a href="tel:${data.phone}" style="color: #666; font-size: 0.9rem;">${data.phone}</a>
                        </td>
                        <td>
                            <div style="font-weight: bold;">${data.date}</div>
                            <div style="font-size: 0.85rem;">${data.time}</div>
                        </td>
                        <td>
                            <div>${data.guests} Ppl</div>
                            <div style="font-size: 0.8rem; color: #888;">${data.seating}</div>
                        </td>
                         <td style="font-size: 0.9rem; max-width: 200px;">
                            ${data.occasion !== 'Casual' ? `<span style="color: purple; font-size: 0.8rem;">â˜… ${data.occasion}</span><br>` : ''}
                            ${data.notes || '-'}
                        </td>
                        <td>
                            ${data.status === 'Pending' ? 
                                `<button onclick="updateStatus('${id}', 'Confirmed')" style="color: green; cursor: pointer; border: 1px solid green; background: none; border-radius: 4px;">Confirm</button>` : 
                                '<i class="material-icons" style="color: green; font-size: 18px;">check_circle</i>'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('totalCount').innerText = total;
                document.getElementById('todayCount').innerText = today;
            });
        }

        window.updateStatus = async function(id, status) {
            await updateDoc(doc(db, "bookings", id), { status: status });
        }

        // --- GRAPESJS EDITOR LOGIC ---
        async function initGrapesEditor() {
            // 1. Fetch live content first
            let htmlContent = '';
            try {
                const docSnap = await getDoc(doc(db, "site_content", "live_page"));
                if(docSnap.exists() && docSnap.data().html) {
                    htmlContent = docSnap.data().html;
                } else {
                    // Fallback to fetch index.html if no live content in DB
                    const response = await fetch('index.html');
                    const text = await response.text();
                    const parser = new DOMParser();
                    const docParsed = parser.parseFromString(text, 'text/html');
                    // We only want the body content for editing, roughly
                    htmlContent = docParsed.body.innerHTML || "<h1>Welcome</h1>";
                }
            } catch(e) { console.error(e); htmlContent = "<h1>Start Building</h1>"; }

            // 2. Initialize GrapesJS
            window.editor = grapesjs.init({
                container: '#gjs',
                fromElement: false,
                height: '100%',
                width: 'auto',
                storageManager: false, // We handle saving manually
                plugins: ['gjs-preset-webpage'],
                pluginsOpts: {
                    'gjs-preset-webpage': {
                        modalImportTitle: 'Import',
                        modalImportLabel: '<div style="margin-bottom: 10px; font-size: 13px;">Paste your HTML here</div>',
                        modalImportContent: function(editor) {
                            return editor.getHtml() + '<style>'+editor.getCss()+'</style>'
                        },
                    }
                },
                canvas: {
                    styles: [
                        'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap',
                        'https://fonts.googleapis.com/icon?family=Material+Icons',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css'
                    ]
                }
            });

            // 3. Load Content
            window.editor.setComponents(htmlContent);
            
            // 4. Add Notification
            window.editor.on('load', () => {
                const pn = window.editor.Panels;
                // Clean up some default buttons to simplify for user
                pn.removeButton('options', 'sw-visibility');
                pn.removeButton('options', 'fullscreen');
                pn.removeButton('options', 'export-template');
            });
        }

        window.saveWebsiteChanges = async function() {
            const btn = document.querySelector('.save-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="material-icons spin">refresh</i> Saving...';
            
            if(!window.editor) return;

            // Get HTML and CSS
            const html = window.editor.getHtml();
            const css = window.editor.getCss();
            
            // Combine them so index.html can render it simply
            // We wrap CSS in a style tag and prepend to HTML
            const fullContent = `<style>${css}</style>${html}`;

            try {
                await setDoc(doc(db, "site_content", "live_page"), {
                    html: fullContent,
                    updatedAt: serverTimestamp()
                });
                alert("Website Updated Successfully!");
            } catch(e) {
                alert("Error saving: " + e.message);
            }
            
            btn.innerHTML = originalText;
        }

    </script>
</body>
</html>
